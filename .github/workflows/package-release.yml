name: Package and Release to GitHub and GitLab

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  package-and-release:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: python -m pip install --upgrade pip requests

      - name: Build submitter dependencies
        run: python build.py build

      - name: Commit updated submitter
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          set -euo pipefail
          git config --global user.name "DestinyleSnowy"
          git config --global user.email "destinylesnowyx@gmail.com"

          git fetch origin "$DEFAULT_BRANCH"
          REMOTE_SHA=$(git rev-parse "origin/$DEFAULT_BRANCH")
          if [ "$REMOTE_SHA" != "$GITHUB_SHA" ]; then
            echo "Skipping push because $DEFAULT_BRANCH is at $REMOTE_SHA instead of release commit $GITHUB_SHA."
            exit 0
          fi

          if [ -d Better-Names-for-7FA4/submitter ]; then
            git add Better-Names-for-7FA4/submitter
          fi
          if [ -f Better-Names-for-7FA4/submitters.json ]; then
            git add Better-Names-for-7FA4/submitters.json
          fi
          if git diff --cached --quiet; then
            echo "No submitter changes to commit."
            exit 0
          fi

          git commit -m "chore: update submitter dependencies for $GITHUB_REF_NAME"
          git push origin HEAD:"$DEFAULT_BRANCH"

      - name: Create ZIP package
        run: |
          cd Better-Names-for-7FA4
          zip -r ../Better-Names-for-7FA4-${{ github.ref_name }}.zip .

      - name: Push tag to GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          set -euo pipefail
          git config --global user.name "yx"
          git config --global user.email "yx@7fa4.cn"
          git remote remove gitlab 2>/dev/null || true
          git remote add gitlab http://oauth2:$GITLAB_TOKEN@jx.7fa4.cn:9080/yx/better-names-for-7fa4.git
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          git push gitlab "refs/tags/$TAG_NAME:refs/tags/$TAG_NAME"

      - name: Update version file in GitLab (no GitLab CI)
        env:
          GITLAB_URL: "http://jx.7fa4.cn:9080"
          PROJECT_ID: ${{ secrets.GITLAB_PROJECT_ID }}         
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}            
          DEFAULT_BRANCH: ${{ secrets.GITLAB_DEFAULT_BRANCH }} 
        run: |
          set -euo pipefail

          PROJECT_ID="${PROJECT_ID:-408}"
          DEFAULT_BRANCH="${DEFAULT_BRANCH:-main}"
          TAG="${GITHUB_REF#refs/tags/}"

          if echo "$TAG" | grep -Eq '^[0-9]+(\.[0-9]+)*$'; then
            VERSION="$TAG"
          else
            VERSION="${TAG##* }"
          fi
          echo "Will write version: $VERSION"

          UPDATE_JSON="{\"branch\":\"${DEFAULT_BRANCH}\",\"commit_message\":\"chore: update version to ${VERSION} from GitHub Actions\",\"actions\":[{\"action\":\"update\",\"file_path\":\"version\",\"content\":\"${VERSION}\"}]}"
          CREATE_JSON="{\"branch\":\"${DEFAULT_BRANCH}\",\"commit_message\":\"chore: add version ${VERSION} from GitHub Actions\",\"actions\":[{\"action\":\"create\",\"file_path\":\"version\",\"content\":\"${VERSION}\"}]}"

          RESP=$(mktemp)
          CODE=$(curl -sS -w '%{http_code}' -o "$RESP" -X POST \
            -H "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
            -H "Content-Type: application/json" \
            --data "$UPDATE_JSON" \
            "${GITLAB_URL}/api/v4/projects/${PROJECT_ID}/repository/commits")
          echo "update status=$CODE"; cat "$RESP" || true

          if [ "$CODE" -lt 200 ] || [ "$CODE" -ge 300 ]; then
            RESP2=$(mktemp)
            CODE2=$(curl -sS -w '%{http_code}' -o "$RESP2" -X POST \
              -H "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
              -H "Content-Type: application/json" \
              --data "$CREATE_JSON" \
              "${GITLAB_URL}/api/v4/projects/${PROJECT_ID}/repository/commits")
            echo "create status=$CODE2"; cat "$RESP2" || true
            test "$CODE2" -ge 200 -a "$CODE2" -lt 300
          fi

      - name: Push CHANGELOG to GitLab
        env:
          GITLAB_URL: "http://jx.7fa4.cn:9080"
          PROJECT_ID: ${{ secrets.GITLAB_PROJECT_ID }}
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          DEFAULT_BRANCH: ${{ secrets.GITLAB_DEFAULT_BRANCH }}
        run: |
          set -euo pipefail
          PROJECT_ID="${PROJECT_ID:-408}"
          DEFAULT_BRANCH="${DEFAULT_BRANCH:-main}"
          TAG="${GITHUB_REF#refs/tags/}"

          if [ -f CHANGELOG.md ]; then
            CHANGELOG_PATH="CHANGELOG.md"
          elif [ -f Better-Names-for-7FA4/CHANGELOG.md ]; then
            CHANGELOG_PATH="Better-Names-for-7FA4/CHANGELOG.md"
          else
            echo "No CHANGELOG found in repository; skipping CHANGELOG push."
            exit 0
          fi

          FILE_NAME=$(basename "$CHANGELOG_PATH")

          sudo apt-get update -y
          sudo apt-get install -y jq

          CONTENT=$(cat "$CHANGELOG_PATH")

          UPDATE_JSON=$(jq -n --arg branch "$DEFAULT_BRANCH" \
                              --arg cm "chore: update $FILE_NAME for $TAG from GitHub Actions" \
                              --arg file "$FILE_NAME" \
                              --arg content "$CONTENT" \
                              '{branch:$branch, commit_message:$cm, actions:[{action:"update", file_path:$file, content:$content}]}')

          RESP=$(mktemp)
          CODE=$(curl -sS -w '%{http_code}' -o "$RESP" -X POST \
            -H "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
            -H "Content-Type: application/json" \
            --data "$UPDATE_JSON" \
            "${GITLAB_URL}/api/v4/projects/${PROJECT_ID}/repository/commits")
          echo "update CHANGELOG status=$CODE"; cat "$RESP" || true

          if [ "$CODE" -lt 200 ] || [ "$CODE" -ge 300 ]; then
            CREATE_JSON=$(jq -n --arg branch "$DEFAULT_BRANCH" \
                                --arg cm "chore: add $FILE_NAME $TAG from GitHub Actions" \
                                --arg file "$FILE_NAME" \
                                --arg content "$CONTENT" \
                                '{branch:$branch, commit_message:$cm, actions:[{action:"create", file_path:$file, content:$content}]}')

            RESP2=$(mktemp)
            CODE2=$(curl -sS -w '%{http_code}' -o "$RESP2" -X POST \
              -H "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
              -H "Content-Type: application/json" \
              --data "$CREATE_JSON" \
              "${GITLAB_URL}/api/v4/projects/${PROJECT_ID}/repository/commits")
            echo "create CHANGELOG status=$CODE2"; cat "$RESP2" || true
            test "$CODE2" -ge 200 -a "$CODE2" -lt 300
          fi

      - name: Create GitLab Release
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITLAB_URL: "http://jx.7fa4.cn:9080"
        run: |
          set -euo pipefail
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          ZIP_FILE="Better-Names-for-7FA4-$TAG_NAME.zip"
          PROJECT_ID="yx%2Fbetter-names-for-7fa4"

          UPLOAD_RESPONSE=$(curl -s --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
            --form "file=@$ZIP_FILE" \
            "$GITLAB_URL/api/v4/projects/$PROJECT_ID/uploads")

          UPLOAD_MARKDOWN=$(echo "$UPLOAD_RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['markdown'])")

          curl --fail -sS --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
            --header "Content-Type: application/json" \
            --data "{
              \"tag_name\": \"$TAG_NAME\",
              \"name\": \"Better Names for 7FA4 $TAG_NAME\",
              \"description\": \"Automated release from GitHub Actions. Download: $UPLOAD_MARKDOWN\"
            }" \
            "$GITLAB_URL/api/v4/projects/$PROJECT_ID/releases" >/dev/null

          echo "GitLab release created successfully!"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: Better-Names-for-7FA4-${{ github.ref_name }}.zip
          name: Release ${{ github.ref_name }}
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
