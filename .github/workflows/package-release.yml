name: Package and Release to GitHub and GitLab

on:
  push:
    tags:
      - '*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  package-and-release:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: python -m pip install --upgrade pip requests

      - name: Build submitter dependencies
        run: python build.py build

      - name: Commit updated submitter
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          set -euo pipefail
          git config --global user.name "DestinyleSnowy"
          git config --global user.email "destinylesnowyx@gmail.com"

          git fetch origin "$DEFAULT_BRANCH"
          REMOTE_SHA=$(git rev-parse "origin/$DEFAULT_BRANCH")
          if [ "$REMOTE_SHA" != "$GITHUB_SHA" ]; then
            echo "Skipping push because $DEFAULT_BRANCH is at $REMOTE_SHA instead of release commit $GITHUB_SHA."
            exit 0
          fi

          if [ -d Better-Names-for-7FA4/submitter ]; then
            git add Better-Names-for-7FA4/submitter
          fi
          if [ -f Better-Names-for-7FA4/submitters.json ]; then
            git add Better-Names-for-7FA4/submitters.json
          fi
          if git diff --cached --quiet; then
            echo "No submitter changes to commit."
            exit 0
          fi

          git commit -m "chore: update submitter dependencies for $GITHUB_REF_NAME"
          git push origin HEAD:"$DEFAULT_BRANCH"

      - name: Create ZIP package
        run: |
          cd Better-Names-for-7FA4
          zip -r ../Better-Names-for-7FA4-${{ github.ref_name }}.zip .


      - name: Push tag to GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        run: |
          set -euo pipefail
          git config --global user.name "yx"
          git config --global user.email "yx@7fa4.cn"
          git remote add gitlab http://oauth2:$GITLAB_TOKEN@jx.7fa4.cn:9080/yx/better-names-for-7fa4.git
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          git push gitlab "refs/tags/$TAG_NAME:refs/tags/$TAG_NAME"

      - name: Trigger GitLab pipeline (update version on default branch)
        env:
          GITLAB_URL: "http://jx.7fa4.cn:9080"
          PROJECT_ID: "408" 
          GITLAB_TRIGGER_TOKEN: ${{ secrets.GITLAB_TRIGGER_TOKEN }}
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          set -euo pipefail
          TAG_NAME="${GITHUB_REF#refs/tags/}"

          curl -sS -X POST \
            -F token="$GITLAB_TRIGGER_TOKEN" \
            -F ref="$DEFAULT_BRANCH" \
            -F "variables[RELEASE_TAG]=$TAG_NAME" \
            "$GITLAB_URL/api/v4/projects/$PROJECT_ID/trigger/pipeline"

      - name: Create GitLab Release
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITLAB_URL: "http://jx.7fa4.cn:9080"
        run: |
          set -euo pipefail
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          ZIP_FILE="Better-Names-for-7FA4-$TAG_NAME.zip"
          PROJECT_ID="yx%2Fbetter-names-for-7fa4"

          UPLOAD_RESPONSE=$(curl -s --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
            --form "file=@$ZIP_FILE" \
            "$GITLAB_URL/api/v4/projects/$PROJECT_ID/uploads")

          UPLOAD_MARKDOWN=$(echo "$UPLOAD_RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['markdown'])")

          curl --fail -sS --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
            --header "Content-Type: application/json" \
            --data "{
              \"tag_name\": \"$TAG_NAME\",
              \"name\": \"Better Names for 7FA4 $TAG_NAME\",
              \"description\": \"Automated release from GitHub Actions. Download: $UPLOAD_MARKDOWN\"
            }" \
            "$GITLAB_URL/api/v4/projects/$PROJECT_ID/releases" >/dev/null

          echo "GitLab release created successfully!"

          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }} 
          files: Better-Names-for-7FA4-${{ github.ref_name }}.zip
          name: Release ${{ github.ref_name }}
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
